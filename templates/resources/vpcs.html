{% extends 'base.html' %}
{% load static %}

{% block title %}VPCs - AWS Resource Inventory{% endblock %}

{% block content %}
<div class="flex justify-between items-center fade-in mb-8">
    <div>
        <h2 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-network-wired text-aws-orange"></i> VPCs & Subnets
        </h2>
        <p class="text-gray-600">Hierarchical view of VPCs, Subnets, and all associated resources</p>
    </div>
    <div class="flex gap-2">
        <button onclick="expandAll()"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-plus-circle"></i> Expand All
        </button>
        <button onclick="collapseAll()"
                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-minus-circle"></i> Collapse All
        </button>
        <button onclick="location.reload()"
                class="bg-aws-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8 fade-in">
    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-blue-500">
        <h3 class="text-3xl font-bold text-gray-900 mb-2">{{ total_vpcs }}</h3>
        <p class="text-gray-600"><i class="fas fa-cloud mr-2 text-blue-500"></i>VPCs</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-green-500">
        <h3 class="text-3xl font-bold text-gray-900 mb-2">{{ total_subnets }}</h3>
        <p class="text-gray-600"><i class="fas fa-layer-group mr-2 text-green-500"></i>Subnets</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-indigo-500">
        <h3 class="text-3xl font-bold text-gray-900 mb-2">{{ total_enis }}</h3>
        <p class="text-gray-600"><i class="fas fa-network-wired mr-2 text-indigo-500"></i>ENIs</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-purple-500">
        <h3 class="text-3xl font-bold text-gray-900 mb-2">{{ total_ec2 }}</h3>
        <p class="text-gray-600"><i class="fas fa-server mr-2 text-purple-500"></i>EC2</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-yellow-500">
        <h3 class="text-3xl font-bold text-gray-900 mb-2">{{ total_sgs }}</h3>
        <p class="text-gray-600"><i class="fas fa-shield-alt mr-2 text-yellow-500"></i>SGs</p>
    </div>
</div>

<div class="bg-white shadow-lg rounded-lg mb-6">
    <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
        <h5 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-filter mr-2 text-aws-orange"></i>Filters
        </h5>
    </div>
    <div class="p-6">
        <form method="get" action="{% url 'vpcs' %}">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                    <select name="region" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange">
                        <option value="">All Regions</option>
                        {% for region in regions %}
                            <option value="{{ region }}" {% if selected_region == region %}selected{% endif %}>{{ region }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Account</label>
                    <select name="account" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange">
                        <option value="">All Accounts</option>
                        {% for account in accounts %}
                            <option value="{{ account }}" {% if selected_account == account %}selected{% endif %}>{{ account }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                    <select name="state" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange">
                        <option value="">All States</option>
                        {% for state in states %}
                            <option value="{{ state }}" {% if selected_state == state %}selected{% endif %}>{{ state }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">&nbsp;</label>
                    <div class="flex gap-2">
                        <button type="submit" class="bg-aws-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
                            <i class="fas fa-search"></i> Apply
                        </button>
                        <a href="{% url 'vpcs' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
                            <i class="fas fa-times"></i> Clear
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="bg-white shadow-lg rounded-lg">
    <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
        <h5 class="text-lg font-semibold text-gray-900">VPC Hierarchy</h5>
    </div>
    <div class="p-6">
        {% if vpcs %}
            <div class="space-y-6">
                {% for vpc in vpcs %}
                <div class="border border-gray-300 rounded-lg overflow-hidden vpc-container" x-data="{ open: false }">
                    <!-- VPC Header -->
                    <div class="bg-blue-50 px-4 py-3 cursor-pointer hover:bg-blue-100 transition-colors duration-150"
                         @click="open = !open">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <button class="text-blue-600 hover:text-blue-800 focus:outline-none" type="button">
                                    <i :class="open ? 'fas fa-chevron-down' : 'fas fa-chevron-right'"></i>
                                </button>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-cloud text-blue-600"></i>
                                        <span class="font-bold text-gray-900">{{ vpc.vpc_id }}</span>
                                        <code class="bg-blue-100 px-2 py-0.5 rounded text-xs">{{ vpc.cidr_block }}</code>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                            {{ vpc.region }}
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                            {{ vpc.state }}
                                        </span>
                                        {% if vpc.is_default %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                            <i class="fas fa-star mr-1"></i>Default
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Account: <code class="bg-gray-100 px-1 py-0.5 rounded">{{ vpc.owner_account }}</code>
                                        • Subnets: {{ vpc.subnet_list|length }}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span class="px-2 py-1 bg-white rounded border border-gray-200">
                                    <i class="fas fa-layer-group text-green-600"></i> {{ vpc.subnet_list|length }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- VPC Content (Subnets) -->
                    <div x-show="open" x-transition class="border-t border-gray-200" style="display: none;">
                        {% if vpc.subnet_list %}
                            <div class="p-4 space-y-4">
                                {% for subnet in vpc.subnet_list %}
                                <div class="border border-gray-200 rounded-lg overflow-hidden subnet-container" x-data="{ subnetOpen: false }">
                                    <!-- Subnet Header -->
                                    <div class="bg-green-50 px-4 py-3 cursor-pointer hover:bg-green-100 transition-colors duration-150"
                                         @click="subnetOpen = !subnetOpen">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <button class="text-green-600 hover:text-green-800 focus:outline-none" type="button">
                                                    <i :class="subnetOpen ? 'fas fa-chevron-down' : 'fas fa-chevron-right'"></i>
                                                </button>
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <i class="fas fa-layer-group text-green-600"></i>
                                                        <span class="font-semibold text-gray-900">{{ subnet.name|default:subnet.subnet_id }}</span>
                                                        {% if subnet.name %}
                                                        <code class="bg-gray-100 px-1.5 py-0.5 rounded text-xs">{{ subnet.subnet_id }}</code>
                                                        {% endif %}
                                                        <code class="bg-green-100 px-2 py-0.5 rounded text-xs">{{ subnet.cidr_block }}</code>
                                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                                            {{ subnet.availability_zone }}
                                                        </span>
                                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                                            {{ subnet.state }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex gap-2 text-xs">
                                                <span class="px-2 py-1 bg-white rounded border border-gray-200" title="ENIs">
                                                    <i class="fas fa-network-wired text-indigo-600"></i> {{ subnet.eni_list|length }}
                                                </span>
                                                <span class="px-2 py-1 bg-white rounded border border-gray-200" title="EC2 Instances">
                                                    <i class="fas fa-server text-purple-600"></i> {{ subnet.ec2_list|length }}
                                                </span>
                                                <span class="px-2 py-1 bg-white rounded border border-gray-200" title="Security Groups">
                                                    <i class="fas fa-shield-alt text-yellow-600"></i> {{ subnet.sg_list|length }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Subnet Content (Resources) -->
                                    <div x-show="subnetOpen" x-transition class="border-t border-gray-200 bg-gray-50" style="display: none;">
                                        <div class="p-4">
                                            <!-- ENIs Section -->
                                            {% if subnet.eni_list %}
                                            <div class="mb-4">
                                                <h6 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                                    <i class="fas fa-network-wired text-indigo-600"></i>
                                                    Elastic Network Interfaces ({{ subnet.eni_list|length }})
                                                </h6>
                                                <div class="space-y-2">
                                                    {% for eni in subnet.eni_list %}
                                                    <div class="bg-white border border-gray-200 rounded p-3">
                                                        <div class="flex items-start justify-between">
                                                            <div class="flex-1">
                                                                <div class="flex items-center gap-2 mb-1">
                                                                    <a href="{% url 'eni_detail' eni.id %}" class="font-medium text-blue-600 hover:text-blue-800 hover:underline text-sm">
                                                                        {{ eni.name|default:eni.eni_id }}
                                                                    </a>
                                                                    {% if eni.name %}
                                                                    <code class="bg-gray-100 px-1.5 py-0.5 rounded text-xs">{{ eni.eni_id }}</code>
                                                                    {% endif %}
                                                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-{% if eni.status == 'in-use' %}green{% else %}gray{% endif %}-100 text-{% if eni.status == 'in-use' %}green{% else %}gray{% endif %}-800">
                                                                        {{ eni.status }}
                                                                    </span>
                                                                </div>
                                                                <div class="text-xs text-gray-600 space-y-1">
                                                                    <div>
                                                                        <span class="text-gray-500">Private IP:</span>
                                                                        <code class="bg-gray-100 px-1.5 py-0.5 rounded">{{ eni.private_ip_address }}</code>
                                                                        {% if eni.public_ip_address %}
                                                                        • <span class="text-gray-500">Public IP:</span>
                                                                        <code class="bg-blue-100 px-1.5 py-0.5 rounded">{{ eni.public_ip_address }}</code>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% if eni.secondary_ips.all %}
                                                                    <div>
                                                                        <span class="text-gray-500">Secondary IPs:</span>
                                                                        {% for ip in eni.secondary_ips.all %}
                                                                        <code class="bg-gray-100 px-1.5 py-0.5 rounded">{{ ip.ip_address }}</code>
                                                                        {% endfor %}
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if eni.ec2_instance %}
                                                                    <div>
                                                                        <span class="text-gray-500">EC2:</span>
                                                                        <a href="{% url 'ec2_instance_detail' eni.ec2_instance.id %}" class="text-blue-600 hover:underline">
                                                                            {{ eni.ec2_instance.name|default:eni.ec2_instance.instance_id }}
                                                                        </a>
                                                                        <span class="text-gray-400">({{ eni.ec2_instance.instance_type }})</span>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% with sgs=eni.eni_security_groups.all %}
                                                                    {% if sgs %}
                                                                    <div>
                                                                        <span class="text-gray-500">Security Groups:</span>
                                                                        {% for eni_sg in sgs %}
                                                                        <a href="{% url 'security_group_detail' eni_sg.security_group.id %}" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-yellow-100 text-yellow-800 hover:bg-yellow-200">
                                                                            {{ eni_sg.security_group.name|truncatechars:15 }}
                                                                        </a>
                                                                        {% endfor %}
                                                                    </div>
                                                                    {% endif %}
                                                                    {% endwith %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% endif %}

                                            <!-- EC2 Instances Section -->
                                            {% if subnet.ec2_list %}
                                            <div class="mb-4">
                                                <h6 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                                    <i class="fas fa-server text-purple-600"></i>
                                                    EC2 Instances ({{ subnet.ec2_list|length }})
                                                </h6>
                                                <div class="space-y-2">
                                                    {% for instance in subnet.ec2_list %}
                                                    <div class="bg-white border border-gray-200 rounded p-3">
                                                        <div class="flex items-center gap-2 mb-1">
                                                            <a href="{% url 'ec2_instance_detail' instance.id %}" class="font-medium text-blue-600 hover:text-blue-800 hover:underline text-sm">
                                                                {{ instance.name|default:instance.instance_id }}
                                                            </a>
                                                            {% if instance.name %}
                                                            <code class="bg-gray-100 px-1.5 py-0.5 rounded text-xs">{{ instance.instance_id }}</code>
                                                            {% endif %}
                                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-{% if instance.state == 'running' %}green{% elif instance.state == 'stopped' %}red{% else %}gray{% endif %}-100 text-{% if instance.state == 'running' %}green{% elif instance.state == 'stopped' %}red{% else %}gray{% endif %}-800">
                                                                {{ instance.state }}
                                                            </span>
                                                            <span class="text-xs text-gray-500">{{ instance.instance_type }}</span>
                                                        </div>
                                                        <div class="text-xs text-gray-600">
                                                            {% if instance.private_ip_address %}
                                                            <code class="bg-gray-100 px-1.5 py-0.5 rounded">{{ instance.private_ip_address }}</code>
                                                            {% endif %}
                                                            {% if instance.public_ip_address %}
                                                            <code class="bg-blue-100 px-1.5 py-0.5 rounded">{{ instance.public_ip_address }}</code>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% endif %}

                                            <!-- Security Groups Section -->
                                            {% if subnet.sg_list %}
                                            <div>
                                                <h6 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                                    <i class="fas fa-shield-alt text-yellow-600"></i>
                                                    Security Groups ({{ subnet.sg_list|length }})
                                                </h6>
                                                <div class="space-y-2">
                                                    {% for sg in subnet.sg_list %}
                                                    <div class="bg-white border border-gray-200 rounded p-3">
                                                        <div class="flex items-center justify-between">
                                                            <div>
                                                                <a href="{% url 'security_group_detail' sg.id %}" class="font-medium text-blue-600 hover:text-blue-800 hover:underline text-sm">
                                                                    {{ sg.name }}
                                                                </a>
                                                                <code class="bg-gray-100 px-1.5 py-0.5 rounded text-xs ml-2">{{ sg.sg_id }}</code>
                                                                {% if sg.description %}
                                                                <p class="text-xs text-gray-500 mt-1">{{ sg.description|truncatechars:60 }}</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% endif %}

                                            {% if not subnet.eni_list and not subnet.ec2_list and not subnet.sg_list %}
                                            <div class="text-center py-8 text-gray-500 text-sm">
                                                <i class="fas fa-inbox text-gray-300 text-3xl mb-2"></i>
                                                <p>No resources found in this subnet</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="p-6 text-center text-gray-500 text-sm">
                                <i class="fas fa-inbox text-gray-300 text-3xl mb-2"></i>
                                <p>No subnets found in this VPC</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12">
                <div class="mb-4">
                    <i class="fas fa-cloud text-gray-300 text-6xl"></i>
                </div>
                <h5 class="text-xl font-semibold text-gray-600 mb-3">No VPCs found</h5>
                <p class="text-gray-500 mb-6">Poll an AWS account to discover VPCs and their resources.</p>
                <a href="{% url 'accounts' %}"
                   class="bg-aws-orange hover:bg-orange-600 text-white px-6 py-3 rounded-lg transition-all duration-200 inline-flex items-center gap-2">
                    <i class="fas fa-users"></i> Go to Accounts
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function expandAll() {
    // Trigger click on all collapsed VPC and subnet headers
    document.querySelectorAll('.vpc-container').forEach(vpc => {
        const alpineData = Alpine.$data(vpc);
        if (!alpineData.open) {
            alpineData.open = true;
        }
    });

    // Give VPCs time to expand, then expand subnets
    setTimeout(() => {
        document.querySelectorAll('.subnet-container').forEach(subnet => {
            const alpineData = Alpine.$data(subnet);
            if (!alpineData.subnetOpen) {
                alpineData.subnetOpen = true;
            }
        });
    }, 100);
}

function collapseAll() {
    // Collapse all subnets first
    document.querySelectorAll('.subnet-container').forEach(subnet => {
        const alpineData = Alpine.$data(subnet);
        if (alpineData.subnetOpen) {
            alpineData.subnetOpen = false;
        }
    });

    // Then collapse VPCs
    setTimeout(() => {
        document.querySelectorAll('.vpc-container').forEach(vpc => {
            const alpineData = Alpine.$data(vpc);
            if (alpineData.open) {
                alpineData.open = false;
            }
        });
    }, 100);
}
</script>
{% endblock %}
