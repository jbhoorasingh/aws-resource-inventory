{% extends 'base.html' %}

{% block title %}User Profile - AWS Resource Inventory{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">
                <i class="fas fa-user-circle text-aws-orange mr-2"></i>
                User Profile
            </h1>
            <p class="text-gray-600 mt-2">Manage your account settings and API access</p>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="rounded-md {% if message.tags == 'error' %}bg-red-50 border border-red-200{% else %}bg-green-50 border border-green-200{% endif %} p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            {% if message.tags == 'error' %}
                                <i class="fas fa-exclamation-circle text-red-400"></i>
                            {% else %}
                                <i class="fas fa-check-circle text-green-400"></i>
                            {% endif %}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium {% if message.tags == 'error' %}text-red-800{% else %}text-green-800{% endif %}">
                                {{ message }}
                            </p>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        <!-- User Information Card -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden mb-6">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-info-circle text-aws-orange mr-2"></i>
                    Account Information
                </h2>
            </div>
            <div class="px-6 py-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <p class="text-gray-900 text-lg">{{ user.username }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <p class="text-gray-900 text-lg">{{ user.email|default:"Not set" }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <p class="text-gray-900 text-lg">{{ user.first_name|default:"Not set" }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <p class="text-gray-900 text-lg">{{ user.last_name|default:"Not set" }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Account Type</label>
                        <p class="text-gray-900 text-lg">
                            {% if user.is_superuser %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    <i class="fas fa-crown mr-1"></i> Superuser
                                </span>
                            {% elif perms.resources.can_poll_accounts %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <i class="fas fa-user-check mr-1"></i> Can Poll Accounts
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-eye mr-1"></i> Read-Only
                                </span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Staff Access</label>
                        <p class="text-gray-900 text-lg">
                            {% if user.is_staff %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check mr-1"></i> Yes
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-times mr-1"></i> No
                                </span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDL API Token Card -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden mb-6">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-key text-aws-orange mr-2"></i>
                    EDL API Token
                </h2>
            </div>
            <div class="px-6 py-6">
                <p class="text-sm text-gray-600 mb-4">
                    Use this token to authenticate with External Dynamic List (EDL) endpoints for firewall integration.
                    Append it as a query parameter: <code class="bg-gray-100 px-2 py-1 rounded text-xs">?token=YOUR_TOKEN</code>
                </p>

                <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your API Token</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" readonly value="{{ api_token }}"
                               id="api-token-input"
                               class="flex-1 bg-white border border-gray-300 rounded-md px-3 py-2 text-sm font-mono text-gray-900 focus:outline-none focus:ring-2 focus:ring-aws-orange focus:border-transparent">
                        <button onclick="copyToken()"
                                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-2">
                            <i class="fas fa-copy"></i>
                            <span>Copy</span>
                        </button>
                    </div>
                    <p id="copy-feedback" class="text-sm text-green-600 mt-2 hidden">
                        <i class="fas fa-check-circle mr-1"></i>
                        Token copied to clipboard!
                    </p>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">Security Warning</h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <ul class="list-disc list-inside space-y-1">
                                    <li>Keep your API token secure and never share it publicly</li>
                                    <li>Regenerating your token will invalidate all existing EDL URLs using the old token</li>
                                    <li>Update your firewall configurations after regenerating the token</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <form method="post" action="{% url 'regenerate_token' %}" onsubmit="return confirm('Are you sure you want to regenerate your API token? This will invalidate all existing EDL URLs.');">
                    {% csrf_token %}
                    <button type="submit"
                            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200 flex items-center space-x-2">
                        <i class="fas fa-sync-alt"></i>
                        <span>Regenerate Token</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- REST API Token Card -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-code text-aws-orange mr-2"></i>
                    REST API Token
                </h2>
            </div>
            <div class="px-6 py-6">
                <p class="text-sm text-gray-600 mb-4">
                    Use this token to authenticate with the REST API endpoints for programmatic access.
                    Include it in the <code class="bg-gray-100 px-2 py-1 rounded text-xs">Authorization</code> header:
                    <code class="bg-gray-100 px-2 py-1 rounded text-xs">Authorization: Token YOUR_TOKEN</code>
                </p>

                <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your REST API Token</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" readonly value="{{ drf_token }}"
                               id="drf-token-input"
                               class="flex-1 bg-white border border-gray-300 rounded-md px-3 py-2 text-sm font-mono text-gray-900 focus:outline-none focus:ring-2 focus:ring-aws-orange focus:border-transparent">
                        <button onclick="copyDRFToken()"
                                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors duration-200 flex items-center space-x-2">
                            <i class="fas fa-copy"></i>
                            <span>Copy</span>
                        </button>
                    </div>
                    <p id="copy-drf-feedback" class="text-sm text-green-600 mt-2 hidden">
                        <i class="fas fa-check-circle mr-1"></i>
                        Token copied to clipboard!
                    </p>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-600"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">Usage Example</h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <p class="mb-2">To access the REST API, include the token in your request headers:</p>
                                <pre class="bg-white p-3 rounded text-xs overflow-x-auto"><code>curl -H "Authorization: Token {{ drf_token }}" \
     https://{{ request.get_host }}/api/enis/</code></pre>
                                <p class="mt-3 mb-1">Or obtain a new token via the API:</p>
                                <pre class="bg-white p-3 rounded text-xs overflow-x-auto"><code>curl -X POST https://{{ request.get_host }}/api/auth/token/ \
     -d "username=YOUR_USERNAME&password=YOUR_PASSWORD"</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <strong class="text-gray-900 block mb-2">Token Types:</strong>
                    <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                        <li><strong>EDL API Token</strong> - Used for External Dynamic List endpoints (/edl/*) with query parameter authentication</li>
                        <li><strong>REST API Token</strong> - Used for REST API endpoints (/api/*) with header-based authentication</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyToken() {
    const tokenInput = document.getElementById('api-token-input');
    const feedback = document.getElementById('copy-feedback');

    tokenInput.select();
    tokenInput.setSelectionRange(0, 99999); // For mobile devices

    navigator.clipboard.writeText(tokenInput.value).then(function() {
        feedback.classList.remove('hidden');
        setTimeout(function() {
            feedback.classList.add('hidden');
        }, 3000);
    }).catch(function(err) {
        console.error('Failed to copy token: ', err);
    });
}

function copyDRFToken() {
    const tokenInput = document.getElementById('drf-token-input');
    const feedback = document.getElementById('copy-drf-feedback');

    tokenInput.select();
    tokenInput.setSelectionRange(0, 99999); // For mobile devices

    navigator.clipboard.writeText(tokenInput.value).then(function() {
        feedback.classList.remove('hidden');
        setTimeout(function() {
            feedback.classList.add('hidden');
        }, 3000);
    }).catch(function(err) {
        console.error('Failed to copy DRF token: ', err);
    });
}
</script>
{% endblock %}
