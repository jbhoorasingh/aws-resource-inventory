{% extends 'base.html' %}
{% load static %}

{% block title %}Accounts - AWS Resource Inventory{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex justify-between items-center fade-in mb-8">
    <div>
        <h2 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-users text-aws-orange"></i> AWS Accounts
        </h2>
        <p class="text-gray-600">Manage and monitor your AWS accounts across regions</p>
    </div>
    {% if perms.resources.can_poll_accounts or user.is_superuser %}
    <div class="flex gap-2">
        <button onclick="document.getElementById('pollModal').classList.remove('hidden')"
                class="bg-aws-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-sync"></i> Poll Single Account
        </button>
        <button onclick="document.getElementById('bulkPollModal').classList.remove('hidden')"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-layer-group"></i> Bulk Poll Accounts
        </button>
    </div>
    {% else %}
    <div class="text-sm text-gray-500 bg-gray-50 px-4 py-2 rounded-lg border border-gray-200">
        <i class="fas fa-info-circle mr-1"></i> Read-only access
    </div>
    {% endif %}
</div>

<div class="bg-white shadow-lg rounded-lg fade-in">
    <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
        <h5 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-table mr-2 text-aws-orange"></i>Account Overview
        </h5>
    </div>
    <div class="p-6">
        {% if accounts %}
            <div class="overflow-x-auto -mx-6 px-6">
                <table class="w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Auth</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ENIs</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Polled</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for account in accounts %}
                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                            <td class="px-3 py-3">
                                <div class="flex flex-col">
                                    <code class="bg-gray-100 px-2 py-0.5 rounded text-xs font-mono">{{ account.account_id }}</code>
                                    {% if account.account_name %}
                                        <span class="text-gray-900 text-sm mt-1">{{ account.account_name }}</span>
                                    {% else %}
                                        <span class="text-gray-400 text-xs mt-1">No name</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-3 py-3">
                                {% if account.is_active %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        Active
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        Inactive
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-3">
                                {% if account.role_arn %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" title="{{ account.role_arn }}">
                                        <i class="fas fa-user-shield text-xs mr-1"></i> Role
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-key text-xs mr-1"></i> Direct
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-3">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ account.eni_count }}
                                </span>
                            </td>
                            <td class="px-3 py-3">
                                {% if account.last_polled %}
                                    <div class="text-xs">
                                        <div class="text-gray-900">{{ account.last_polled|date:"M d, Y" }}</div>
                                        <div class="text-gray-500">{{ account.last_polled|date:"H:i" }} ({{ account.last_polled|timesince }} ago)</div>
                                    </div>
                                {% else %}
                                    <span class="text-gray-400 text-xs">Never</span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-3">
                                <span class="text-gray-900 text-xs">{{ account.created_at|date:"M d, Y" }}</span>
                            </td>
                            <td class="px-3 py-3">
                                {% if perms.resources.can_poll_accounts or user.is_superuser %}
                                <button onclick="pollAccount('{{ account.account_id }}', '{{ account.account_name|default:"" }}')"
                                        class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded transition-all duration-200 text-xs">
                                    <i class="fas fa-sync"></i> Poll
                                </button>
                                {% else %}
                                <span class="text-gray-400 text-xs">
                                    <i class="fas fa-lock"></i>
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-12">
                <div class="mb-4">
                    <i class="fas fa-cloud-upload-alt text-gray-300 text-6xl"></i>
                </div>
                <h4 class="text-xl font-semibold text-gray-600 mb-3">No Accounts Yet</h4>
                <p class="text-gray-500 mb-6">Get started by polling your AWS accounts to discover and track resources.</p>
                {% if perms.resources.can_poll_accounts or user.is_superuser %}
                <div class="flex gap-3 justify-center">
                    <button onclick="document.getElementById('pollModal').classList.remove('hidden')"
                            class="bg-aws-orange hover:bg-orange-600 text-white px-6 py-3 rounded-lg transition-all duration-200 text-base">
                        <i class="fas fa-plus mr-2"></i> Add Your First Account
                    </button>
                    <button onclick="document.getElementById('bulkPollModal').classList.remove('hidden')"
                            class="border border-aws-orange text-aws-orange hover:bg-orange-50 px-6 py-3 rounded-lg transition-all duration-200 text-base">
                        <i class="fas fa-layer-group mr-2"></i> Bulk Import
                    </button>
                </div>
                {% else %}
                <p class="text-gray-400 text-sm">
                    <i class="fas fa-lock mr-1"></i> You don't have permission to poll accounts. Contact your administrator.
                </p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Poll Account Modal -->
<div id="pollModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="pollModalLabel" aria-modal="true" role="dialog">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="document.getElementById('pollModal').classList.add('hidden')"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-gradient-to-r from-aws-dark to-aws-light px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-white">
                        <i class="fas fa-sync mr-2"></i> Poll AWS Account
                    </h3>
                    <button type="button" onclick="document.getElementById('pollModal').classList.add('hidden')" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <form id="pollForm" method="post" action="{% url 'poll_account' %}">
                {% csrf_token %}
                <div class="px-6 py-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <div class="flex">
                            <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-2"></i>
                            <div class="text-sm text-blue-700">
                                <strong>Note:</strong> You can use direct credentials OR role assumption for cross-account access.
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="border-b border-gray-200">
                            <nav class="flex -mb-px" id="authTabs">
                                <button type="button" onclick="switchAuthTab('direct')" id="direct-tab"
                                        class="auth-tab active py-2 px-4 border-b-2 border-aws-orange text-aws-orange font-medium text-sm">
                                    <i class="fas fa-key mr-1"></i> Direct Credentials
                                </button>
                                <button type="button" onclick="switchAuthTab('role')" id="role-tab"
                                        class="auth-tab py-2 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm">
                                    <i class="fas fa-user-shield mr-1"></i> Role Assumption
                                </button>
                            </nav>
                        </div>
                    </div>

                    <div id="direct" class="auth-content">
                        <div class="bg-gray-50 p-3 rounded mb-4">
                            <small class="text-gray-700"><strong>Direct Credentials:</strong> Use this for single-account access with long-term or temporary credentials.</small>
                        </div>
                    </div>
                    <div id="role" class="auth-content hidden">
                        <div class="bg-gray-50 p-3 rounded mb-4">
                            <small class="text-gray-700"><strong>Role Assumption:</strong> Use this for multi-account environments. Provide identity account credentials and the role ARN in the target account.</small>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="account_number" class="block text-sm font-medium text-gray-700 mb-1">Account Number *</label>
                            <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="account_number" name="account_number" placeholder="123456789012" required>
                        </div>
                        <div>
                            <label for="account_name" class="block text-sm font-medium text-gray-700 mb-1">Account Name (Optional)</label>
                            <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="account_name" name="account_name" placeholder="Production Account">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="access_key_id" class="block text-sm font-medium text-gray-700 mb-1">Access Key ID *</label>
                            <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="access_key_id" name="access_key_id" placeholder="AKIA..." required>
                        </div>
                        <div>
                            <label for="secret_access_key" class="block text-sm font-medium text-gray-700 mb-1">Secret Access Key *</label>
                            <input type="password" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="secret_access_key" name="secret_access_key" placeholder="Your secret key" required>
                        </div>
                        <div>
                            <label for="session_token" class="block text-sm font-medium text-gray-700 mb-1">Session Token *</label>
                            <input type="password" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="session_token" name="session_token" placeholder="Your session token" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="regions" class="block text-sm font-medium text-gray-700 mb-1">AWS Regions *</label>
                        <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                               id="regions" name="regions" placeholder="us-east-1,us-west-2,eu-west-1" value="us-east-1,us-west-2" required>
                        <p class="mt-1 text-sm text-gray-500">Comma-separated list of regions to scan</p>
                    </div>

                    <hr class="my-6 border-gray-200">

                    <div id="roleAssumptionFields" class="hidden">
                        <h6 class="text-base font-semibold text-gray-900 mb-3">
                            <i class="fas fa-user-shield mr-2 text-aws-orange"></i> Role Assumption Configuration (Optional)
                        </h6>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <div class="flex">
                                <i class="fas fa-exclamation-triangle text-yellow-400 mt-0.5 mr-2"></i>
                                <div class="text-sm text-yellow-700">
                                    <strong>Cross-Account Access:</strong> Use these fields if you want to assume a role in the target account.
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="role_arn" class="block text-sm font-medium text-gray-700 mb-1">
                                Role ARN
                                <i class="fas fa-question-circle text-gray-400" title="ARN of the IAM role to assume in the target account"></i>
                            </label>
                            <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="role_arn" name="role_arn" placeholder="arn:aws:iam::123456789012:role/ResourceDiscoveryRole">
                            <p class="mt-1 text-sm text-gray-500">Example: arn:aws:iam::987654321098:role/ResourceDiscoveryRole</p>
                        </div>

                        <div class="mb-4">
                            <label for="external_id" class="block text-sm font-medium text-gray-700 mb-1">
                                External ID (Optional)
                                <i class="fas fa-question-circle text-gray-400" title="Additional security parameter for role assumption"></i>
                            </label>
                            <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="external_id" name="external_id" placeholder="my-external-id">
                            <p class="mt-1 text-sm text-gray-500">Optional security parameter configured in the IAM trust policy</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('pollModal').classList.add('hidden')"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="pollButton"
                            class="bg-aws-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
                        <i class="fas fa-sync"></i> Start Polling
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Poll Accounts Modal -->
<div id="bulkPollModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="bulkPollModalLabel" aria-modal="true" role="dialog">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="document.getElementById('bulkPollModal').classList.add('hidden')"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
            <div class="bg-gradient-to-r from-aws-dark to-aws-light px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-white">
                        <i class="fas fa-layer-group mr-2"></i> Bulk Poll Multiple AWS Accounts
                    </h3>
                    <button type="button" onclick="document.getElementById('bulkPollModal').classList.add('hidden')" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <form id="bulkPollForm" method="post" action="{% url 'bulk_poll_accounts' %}">
                {% csrf_token %}
                <div class="px-6 py-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <div class="flex">
                            <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-2"></i>
                            <div class="text-sm text-blue-700">
                                <strong>Bulk Polling with Role Assumption:</strong> Poll multiple accounts using the same identity credentials.
                            </div>
                        </div>
                    </div>

                    <h6 class="text-base font-semibold text-gray-900 mb-2">Identity Account Credentials</h6>
                    <p class="text-sm text-gray-600 mb-4">These credentials will be used to assume roles in all target accounts.</p>

                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="bulk_access_key_id" class="block text-sm font-medium text-gray-700 mb-1">Access Key ID *</label>
                            <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="bulk_access_key_id" name="access_key_id" placeholder="AKIA..." required>
                        </div>
                        <div>
                            <label for="bulk_secret_access_key" class="block text-sm font-medium text-gray-700 mb-1">Secret Access Key *</label>
                            <input type="password" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="bulk_secret_access_key" name="secret_access_key" placeholder="Your secret key" required>
                        </div>
                        <div>
                            <label for="bulk_session_token" class="block text-sm font-medium text-gray-700 mb-1">Session Token</label>
                            <input type="password" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                                   id="bulk_session_token" name="session_token" placeholder="Leave empty if using IAM user">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="bulk_regions" class="block text-sm font-medium text-gray-700 mb-1">AWS Regions *</label>
                        <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange"
                               id="bulk_regions" name="regions" placeholder="us-east-1,us-west-2,eu-west-1" value="us-east-1,us-west-2" required>
                        <p class="mt-1 text-sm text-gray-500">Comma-separated list of regions (will be used for all accounts)</p>
                    </div>

                    <hr class="my-6 border-gray-200">

                    <h6 class="text-base font-semibold text-gray-900 mb-2">Target Accounts Configuration</h6>
                    <p class="text-sm text-gray-600 mb-4">Enter one account per line in the format: <code class="bg-gray-100 px-2 py-1 rounded">account_number|account_name|role_arn|external_id</code></p>

                    <div class="mb-4">
                        <label for="bulk_accounts_config" class="block text-sm font-medium text-gray-700 mb-1">Accounts Configuration *</label>
                        <textarea class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange font-mono text-sm"
                                  id="bulk_accounts_config" name="accounts_config" rows="10" required
                                  placeholder="264449297775|Production Account|arn:aws:iam::264449297775:role/PaloInventoryInspectionRole|
123456789012|Dev Account|arn:aws:iam::123456789012:role/PaloInventoryInspectionRole|my-external-id
987654444448|Staging Account|arn:aws:iam::987654444448:role/PaloInventoryInspectionRole|"></textarea>
                        <div class="mt-1 text-sm text-gray-500">
                            <strong>Format:</strong> <code class="bg-gray-100 px-2 py-1 rounded">account_number|account_name|role_arn|external_id</code><br>
                            <strong>Note:</strong> External ID is optional (leave empty or omit the last <code class="bg-gray-100 px-1 rounded">|</code> if not needed)
                        </div>
                    </div>

                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                        <div class="flex">
                            <i class="fas fa-exclamation-triangle text-yellow-400 mt-0.5 mr-2"></i>
                            <div class="text-sm text-yellow-700">
                                <strong>Note:</strong> Accounts will be polled sequentially. This may take several minutes for many accounts.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('bulkPollModal').classList.add('hidden')"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="bulkPollButton"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
                        <i class="fas fa-layer-group"></i> Start Bulk Polling
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.auth-tab.active {
    border-color: #FF9900;
    color: #FF9900;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function pollAccount(accountId, accountName) {
    document.getElementById('account_number').value = accountId;
    document.getElementById('account_name').value = accountName;
    document.getElementById('pollModal').classList.remove('hidden');
}

function switchAuthTab(tab) {
    // Update tab styles
    document.querySelectorAll('.auth-tab').forEach(t => {
        t.classList.remove('active', 'border-aws-orange', 'text-aws-orange');
        t.classList.add('border-transparent', 'text-gray-500');
    });

    const activeTab = document.getElementById(tab + '-tab');
    activeTab.classList.add('active', 'border-aws-orange', 'text-aws-orange');
    activeTab.classList.remove('border-transparent', 'text-gray-500');

    // Show/hide content
    document.querySelectorAll('.auth-content').forEach(c => c.classList.add('hidden'));
    document.getElementById(tab).classList.remove('hidden');

    // Show/hide role assumption fields
    if (tab === 'role') {
        document.getElementById('roleAssumptionFields').classList.remove('hidden');
    } else {
        document.getElementById('roleAssumptionFields').classList.add('hidden');
    }
}

$('#pollForm').on('submit', function(e) {
    const submitBtn = $('#pollButton');
    const originalText = submitBtn.html();

    submitBtn.prop('disabled', true);
    submitBtn.html('<span class="inline-block animate-spin mr-2"><i class="fas fa-spinner"></i></span>Polling...');

    // Re-enable button after 30 seconds as fallback
    setTimeout(function() {
        submitBtn.prop('disabled', false);
        submitBtn.html(originalText);
    }, 30000);
});

$('#bulkPollForm').on('submit', function(e) {
    const submitBtn = $('#bulkPollButton');
    const originalText = submitBtn.html();

    submitBtn.prop('disabled', true);
    submitBtn.html('<span class="inline-block animate-spin mr-2"><i class="fas fa-spinner"></i></span>Bulk Polling...');

    // Re-enable button after 2 minutes as fallback (bulk takes longer)
    setTimeout(function() {
        submitBtn.prop('disabled', false);
        submitBtn.html(originalText);
    }, 120000);
});
</script>
{% endblock %}
