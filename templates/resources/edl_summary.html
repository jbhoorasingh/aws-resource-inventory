{% extends 'base.html' %}
{% load static %}

{% block title %}External Dynamic Lists (EDL) - AWS Resource Inventory{% endblock %}

{% block content %}
<div class="flex justify-between items-center fade-in mb-8">
    <div>
        <h2 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-list-alt text-aws-orange"></i> External Dynamic Lists (EDL)
        </h2>
        <p class="text-gray-600">Generate IP lists for Palo Alto Networks firewalls</p>
    </div>
    <button onclick="location.reload()"
            class="bg-aws-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
        <i class="fas fa-sync"></i> Refresh
    </button>
</div>

<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
    <div class="flex">
        <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-3"></i>
        <div>
            <strong class="text-blue-900">Palo Alto EDL Integration:</strong>
            <span class="text-blue-800"> These endpoints provide IP address lists that can be consumed by Palo Alto firewalls as External Dynamic Lists.</span>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="mb-6">
    <div class="border-b border-gray-200">
        <nav class="flex -mb-px" id="edlTabs">
            <button type="button" onclick="switchTab('accounts')" id="accounts-tab"
                    class="edl-tab active py-3 px-6 border-b-2 border-aws-orange text-aws-orange font-medium text-sm flex items-center gap-2">
                <i class="fas fa-users"></i> Accounts
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-aws-orange text-white ml-1">
                    {{ accounts|length }}
                </span>
            </button>
            <button type="button" onclick="switchTab('security-groups')" id="security-groups-tab"
                    class="edl-tab py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm flex items-center gap-2">
                <i class="fas fa-shield-alt"></i> Security Groups
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-500 text-white ml-1">
                    {{ security_groups|length }}
                </span>
            </button>
            <button type="button" onclick="switchTab('eni-filter')" id="eni-filter-tab"
                    class="edl-tab py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm flex items-center gap-2">
                <i class="fas fa-filter"></i> ENI Filter Builder
            </button>
        </nav>
    </div>
</div>

<div id="edlTabContent">
    <!-- Accounts Tab -->
    <div id="accounts" class="tab-content">
        <div class="bg-white shadow-lg rounded-lg">
            <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <h5 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-users mr-2 text-aws-orange"></i>Account EDLs
                    </h5>
                    <input type="text"
                           class="block w-64 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange text-sm"
                           id="accountSearch"
                           placeholder="Search accounts...">
                </div>
            </div>
            <div class="p-6">
                {% if accounts %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="accountsTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ENIs</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EDL URL</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for account in accounts %}
                                <tr class="hover:bg-gray-50 transition-colors duration-150">
                                    <td class="px-6 py-4">
                                        <strong class="text-gray-900">{{ account.account_name|default:"No name" }}</strong>
                                        <br><small><code class="bg-gray-100 px-2 py-1 rounded text-xs">{{ account.account_id }}</code></small>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ account.eni_count }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <input type="text"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md text-sm font-mono"
                                               readonly
                                               value="https://{{ request.get_host }}/edl/account/{{ account.account_id }}?token={{ api_token }}"
                                               id="url-account-{{ account.account_id }}">
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex gap-1">
                                            <button onclick="copyUrl('url-account-{{ account.account_id }}')"
                                                    class="text-gray-600 hover:text-gray-800 hover:bg-gray-50 px-3 py-1 rounded transition-all duration-200">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <a href="/edl/account/{{ account.account_id }}?token={{ api_token }}"
                                               target="_blank"
                                               class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-3 py-1 rounded transition-all duration-200">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="/edl/account/{{ account.account_id }}/json"
                                               target="_blank"
                                               class="text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 px-3 py-1 rounded transition-all duration-200">
                                                <i class="fas fa-info"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-users text-gray-300 text-6xl mb-4"></i>
                        <h5 class="text-xl font-semibold text-gray-600">No accounts found</h5>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Security Groups Tab -->
    <div id="security-groups" class="tab-content hidden">
        <div class="bg-white shadow-lg rounded-lg">
            <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <h5 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-shield-alt mr-2 text-aws-orange"></i>Security Group EDLs
                    </h5>
                    <input type="text"
                           class="block w-64 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange text-sm"
                           id="sgSearch"
                           placeholder="Search security groups...">
                </div>
            </div>
            <div class="p-6">
                {% if security_groups %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="sgTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Security Group</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VPC</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ENIs</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EDL URL</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for sg in security_groups %}
                                <tr class="hover:bg-gray-50 transition-colors duration-150">
                                    <td class="px-6 py-4">
                                        <strong class="text-gray-900">{{ sg.name }}</strong>
                                        <br><small><code class="bg-gray-100 px-2 py-1 rounded text-xs">{{ sg.sg_id }}</code></small>
                                    </td>
                                    <td class="px-6 py-4">
                                        <code class="bg-gray-100 px-2 py-1 rounded text-xs block mb-1">{{ sg.vpc.vpc_id }}</code>
                                        <small class="text-gray-500">{{ sg.vpc.region }}</small>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ sg.eni_count }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <input type="text"
                                               class="block w-full px-3 py-2 border border-gray-300 rounded-md text-sm font-mono"
                                               readonly
                                               value="https://{{ request.get_host }}/edl/sg/{{ sg.sg_id }}?token={{ api_token }}"
                                               id="url-sg-{{ sg.sg_id }}">
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex gap-1">
                                            <button onclick="copyUrl('url-sg-{{ sg.sg_id }}')"
                                                    class="text-gray-600 hover:text-gray-800 hover:bg-gray-50 px-3 py-1 rounded transition-all duration-200">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <a href="/edl/sg/{{ sg.sg_id }}?token={{ api_token }}"
                                               target="_blank"
                                               class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-3 py-1 rounded transition-all duration-200">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="/edl/sg/{{ sg.sg_id }}/json"
                                               target="_blank"
                                               class="text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 px-3 py-1 rounded transition-all duration-200">
                                                <i class="fas fa-info"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-shield-alt text-gray-300 text-6xl mb-4"></i>
                        <h5 class="text-xl font-semibold text-gray-600">No security groups found</h5>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ENI Filter Builder Tab -->
    <div id="eni-filter" class="tab-content hidden">
        <div class="bg-white shadow-lg rounded-lg">
            <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <h5 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-filter mr-2 text-aws-orange"></i>Build Custom ENI Filter EDL
                </h5>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-6">Create a custom EDL by filtering ENIs based on AWS tags.</p>

                <div class="mb-6">
                    <h6 class="text-base font-semibold text-gray-900 mb-3">Add Tag Filters:</h6>
                    <div id="tagFilters">
                        <div class="grid grid-cols-12 gap-3 mb-3 tag-filter-row">
                            <div class="col-span-5">
                                <input type="text"
                                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange tag-key"
                                       placeholder="Tag Key (e.g., Environment)">
                            </div>
                            <div class="col-span-5">
                                <input type="text"
                                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange tag-value"
                                       placeholder="Tag Value (e.g., PROD)">
                            </div>
                            <div class="col-span-2">
                                <button onclick="removeTagFilter(this)"
                                        disabled
                                        class="w-full bg-red-50 text-red-400 px-3 py-2 rounded-md cursor-not-allowed">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button onclick="addTagFilter()"
                            class="bg-aws-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2 text-sm">
                        <i class="fas fa-plus"></i> Add Another Tag
                    </button>
                </div>

                <div class="mb-6">
                    <h6 class="text-base font-semibold text-gray-900 mb-3">Generated EDL URL:</h6>
                    <div class="flex gap-2">
                        <input type="text"
                               class="block flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange font-mono text-sm"
                               id="generatedUrl"
                               readonly
                               value="https://{{ request.get_host }}/edl/enis/?token={{ api_token }}">
                        <button onclick="copyUrl('generatedUrl')"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <a href="#"
                           id="viewGeneratedUrl"
                           target="_blank"
                           class="bg-aws-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center gap-2">
                            <i class="fas fa-eye"></i> View
                        </a>
                    </div>
                    <small class="text-gray-500 mt-1 block">Tags will be added as query parameters</small>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <strong class="text-gray-900 block mb-2">Example URLs:</strong>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><code class="bg-white px-2 py-1 rounded text-xs">https://{{ request.get_host }}/edl/enis/?token=YOUR_TOKEN&Environment=PROD</code></li>
                        <li><code class="bg-white px-2 py-1 rounded text-xs">https://{{ request.get_host }}/edl/enis/?token=YOUR_TOKEN&Environment=PROD&Application=WebServer</code></li>
                        <li><code class="bg-white px-2 py-1 rounded text-xs">https://{{ request.get_host }}/edl/enis/?token=YOUR_TOKEN&Team=DevOps</code></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Usage Instructions -->
<div class="mt-8">
    <div class="bg-white shadow-lg rounded-lg">
        <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
            <h5 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-book mr-2 text-aws-orange"></i>Palo Alto Configuration
            </h5>
        </div>
        <div class="p-6">
            <h6 class="text-base font-semibold text-gray-900 mb-3">External Dynamic List Setup:</h6>
            <ol class="list-decimal list-inside space-y-2 text-gray-700 mb-6">
                <li>In Palo Alto Panorama or firewall, go to <strong>Objects â†’ External Dynamic Lists</strong></li>
                <li>Click <strong>Add</strong> to create a new EDL</li>
                <li>Configure the EDL with these settings:
                    <ul class="list-disc list-inside ml-6 mt-2 space-y-1">
                        <li><strong>Name:</strong> AWS-ENI-IPs (or your preferred name)</li>
                        <li><strong>Type:</strong> IP List</li>
                        <li><strong>Source:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-xs">https://your-domain.com/edl/account/123456789012</code></li>
                        <li><strong>Update Schedule:</strong> Every 5 minutes (or as needed)</li>
                    </ul>
                </li>
                <li>Use the EDL in security policies to allow/deny traffic from AWS ENI IPs</li>
            </ol>

            <h6 class="text-base font-semibold text-gray-900 mb-3">Example Security Policy:</h6>
            <pre class="bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto"><code># Security Policy Rule
Source: AWS-ENI-IPs (EDL)
Destination: Any
Service: Any
Action: Allow</code></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.edl-tab.active {
    border-color: #FF9900;
    color: #FF9900;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Switch between tabs
function switchTab(tabName) {
    // Update tab styles
    document.querySelectorAll('.edl-tab').forEach(t => {
        t.classList.remove('active', 'border-aws-orange', 'text-aws-orange');
        t.classList.add('border-transparent', 'text-gray-500');
    });

    const activeTab = document.getElementById(tabName + '-tab');
    activeTab.classList.add('active', 'border-aws-orange', 'text-aws-orange');
    activeTab.classList.remove('border-transparent', 'text-gray-500');

    // Show/hide content
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById(tabName).classList.remove('hidden');
}

// Copy URL to clipboard
function copyUrl(inputId) {
    const input = document.getElementById(inputId);
    input.select();
    input.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(input.value).then(function() {
        // Show tooltip or brief notification
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
        }, 1000);
    });
}

// Search functionality for accounts
$(document).ready(function() {
    $('#accountSearch').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('#accountsTable tbody tr').each(function() {
            const rowText = $(this).text().toLowerCase();
            if (rowText.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
});

// Search functionality for security groups
$(document).ready(function() {
    $('#sgSearch').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('#sgTable tbody tr').each(function() {
            const rowText = $(this).text().toLowerCase();
            if (rowText.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
});

// ENI Filter Builder functionality
function addTagFilter() {
    const container = document.getElementById('tagFilters');
    const newRow = document.createElement('div');
    newRow.className = 'grid grid-cols-12 gap-3 mb-3 tag-filter-row';
    newRow.innerHTML = `
        <div class="col-span-5">
            <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange tag-key" placeholder="Tag Key (e.g., Environment)">
        </div>
        <div class="col-span-5">
            <input type="text" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-aws-orange focus:border-aws-orange tag-value" placeholder="Tag Value (e.g., PROD)">
        </div>
        <div class="col-span-2">
            <button onclick="removeTagFilter(this)" class="w-full bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-md transition-all duration-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    container.appendChild(newRow);
    attachTagInputListeners(newRow);
}

function removeTagFilter(button) {
    const row = button.closest('.tag-filter-row');
    row.remove();
    updateGeneratedUrl();
}

function attachTagInputListeners(row) {
    const inputs = row.querySelectorAll('.tag-key, .tag-value');
    inputs.forEach(input => {
        input.addEventListener('input', updateGeneratedUrl);
    });
}

function updateGeneratedUrl() {
    const baseUrl = 'https://{{ request.get_host }}/edl/enis/';
    const params = ['token={{ api_token }}'];  // Always include token as first parameter

    document.querySelectorAll('.tag-filter-row').forEach(row => {
        const key = row.querySelector('.tag-key').value.trim();
        const value = row.querySelector('.tag-value').value.trim();
        if (key && value) {
            params.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`);
        }
    });

    const generatedUrl = baseUrl + '?' + params.join('&');
    document.getElementById('generatedUrl').value = generatedUrl;
    document.getElementById('viewGeneratedUrl').href = generatedUrl;
}

// Initialize tag filter listeners on page load
$(document).ready(function() {
    document.querySelectorAll('.tag-filter-row').forEach(row => {
        attachTagInputListeners(row);
    });
    updateGeneratedUrl();
});
</script>
{% endblock %}
